<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>덱 편집</title>

<!-- 선택: 공통 네비 스타일 사용 시 -->
<link rel="stylesheet" href="style.css">

<style>
  /* 페이지 자체 스타일 (style.css가 없어도 동작하도록 최소 포함) */
  body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; background:#f5f6f8; }
  h1, h2 { text-align:center; margin: 16px 0 8px; }

  .wrap { padding: 8px 12px 80px; } /* 하단 네비 높이만큼 여백 */
  .deck-area {
    max-width: 1100px; margin: 0 auto;
    padding: 10px;
    background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08);
  }

  /* 슬롯 8개 (가로로 8칸, 좁은 화면은 4칸) */
  .slots {
    display:grid; grid-template-columns: repeat(8, 1fr);
    gap:12px; padding:12px;
  }
  @media (max-width: 980px){ .slots{ grid-template-columns: repeat(4, 1fr);} }
  @media (max-width: 560px){ .slots{ grid-template-columns: repeat(2, 1fr);} }

  .slot {
    position:relative; height:160px; border:2px dashed #8aa; border-radius:12px;
    background: linear-gradient(180deg,#fefefe,#f3f6f9);
    display:flex; align-items:center; justify-content:center;
    transition: border-color .15s;
  }
  .slot.over { border-color:#4b9cff; }

  /* 카드 공통 */
  .card {
    width:96px; height:136px; border-radius:12px; border:1px solid #3333;
    background:#fff; display:flex; align-items:center; justify-content:center;
    font-weight:800; cursor:grab; user-select:none; position:relative;
    box-shadow:0 8px 18px rgba(0,0,0,.15);
  }
  .card:active{ cursor:grabbing; }
  .card.small { width:86px; height:122px; } /* 슬롯 안에서 약간 작게 보이게 */
  .card img { width:100%; height:100%; object-fit:cover; border-radius:12px; }

  /* 소유 카드 영역 */
  .owned-panel {
    margin-top: 14px; padding: 12px;
    background:#fff; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .owned-list {
    display:flex; flex-wrap:wrap; gap:10px; justify-content:center;
    min-height: 150px;
  }
  .hint { text-align:center; color:#556; font-size:13px; margin:6px 0 12px; }

  /* 버튼 */
  .toolbar {
    display:flex; gap:8px; justify-content:center; margin: 8px 0 12px;
  }
  .btn {
    border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700;
    background:#1f2b46; color:#e9eef7; box-shadow:0 6px 18px rgba(0,0,0,.25);
  }
  .btn:hover{ filter:brightness(1.08); }
  .btn.light{ background:#e8edf7; color:#1f2b46; }

  /* 하단 네비 (style.css가 없을 때를 대비) */
  .navbar { position: fixed; bottom:0; left:0; width:100%; height:60px; display:flex; border-top:2px solid #333; background:#ddd; z-index:10;}
  .nav-item { flex:1; display:flex; align-items:center; justify-content:center; border-right:1px solid #333; cursor:pointer; font-weight:700;}
  .nav-item:last-child{ border-right:none; } .nav-item:hover{ background:#bbb;}
</style>
</head>
<body>

<div class="wrap">
  <h1>덱 편집</h1>

  <!-- 위: 8개의 세워진 직사각형(슬롯) -->
  <div class="deck-area">
    <div class="slots" id="slots"></div>

    <div class="toolbar">
      <button class="btn light" id="clearDeck">덱 비우기</button>
      <button class="btn" id="saveDeck">저장</button>
    </div>
  </div>

  <!-- 아래: 획득한 카드 목록 -->
  <div class="owned-panel">
    <h2>획득한 카드</h2>
    <div class="hint">아래 카드를 위 슬롯으로 드래그해 덱을 구성하세요. 슬롯에서 다시 아래로 드래그하면 해제됩니다.</div>
    <div class="owned-list" id="ownedList"></div>
  </div>
</div>

<!-- 하단 네비 -->
<div class="navbar">
  <div class="nav-item" onclick="location.href='cards.html'">카드</div>
  <div class="nav-item" onclick="location.href='deck.html'">덱</div>
  <div class="nav-item" onclick="location.href='shop.html'">상점</div>
  <div class="nav-item" onclick="location.href='history.html'">전투 기록</div>
</div>

<script>
/* =========================
   데이터/저장
   ========================= */
const STORAGE_DECK = 'tsw_deck';           // ["C01","C02",...]
const STORAGE_OWN  = 'tsw_owned_cards';    // [{id:"C01", name:"...", img:null},...]

// 최초 예시 소유 카드 (이미지는 나중에 교체)
const SAMPLE_OWNED = [
  { id:"C01", name:"보병",    img:null, color:"#ffd166" },
  { id:"C02", name:"궁수",    img:null, color:"#06d6a0" },
  { id:"C03", name:"기사",    img:null, color:"#118ab2" },
  { id:"C04", name:"법사",    img:null, color:"#ef476f" },
  { id:"C05", name:"방패병",  img:null, color:"#a4b0f5" },
  { id:"C06", name:"창병",    img:null, color:"#ffa69e" },
  { id:"C07", name:"치유사",  img:null, color:"#9ef0b8" },
  { id:"C08", name:"고블린",  img:null, color:"#c3f584" },
  { id:"C09", name:"거인",    img:null, color:"#ffd3b6" },
  { id:"C10", name:"메카",    img:null, color:"#c9c9ff" },
  { id:"C11", name:"암살자",  img:null, color:"#bdb2ff" },
  { id:"C12", name:"마왕",    img:null, color:"#ffadad" }
];

// 로드/세이브
function loadOwned(){ return JSON.parse(localStorage.getItem(STORAGE_OWN) || 'null') || SAMPLE_OWNED; }
function saveOwned(list){ localStorage.setItem(STORAGE_OWN, JSON.stringify(list)); }
function loadDeck(){ return JSON.parse(localStorage.getItem(STORAGE_DECK) || 'null') || Array(8).fill(null); }
function saveDeck(deck){ localStorage.setItem(STORAGE_DECK, JSON.stringify(deck)); }

/* =========================
   DOM 빌드
   ========================= */
const ownedListEl = document.getElementById('ownedList');
const slotsEl     = document.getElementById('slots');

let OWNED = loadOwned();      // [{id,name,img,color}]
let DECK  = loadDeck();       // [id|null] length 8

// 슬롯 8개 만들기
function buildSlots(){
  slotsEl.innerHTML = '';
  for(let i=0;i<8;i++){
    const s = document.createElement('div');
    s.className = 'slot';
    s.dataset.index = i;
    addSlotDnD(s);
    slotsEl.appendChild(s);
  }
}

// 슬롯 내용 렌더
function renderSlots(){
  [...slotsEl.children].forEach((s, idx)=>{
    s.innerHTML = '';
    const cardId = DECK[idx];
    if(cardId){
      const cardData = OWNED.find(c=>c.id===cardId);
      s.appendChild(makeCardElement(cardData, true)); // true = 슬롯용(작게)
    }
  });
}

// 소유 카드 렌더
function renderOwned(){
  ownedListEl.innerHTML = '';
  const usedIds = new Set(DECK.filter(Boolean));
  OWNED.forEach(c=>{
    if(!usedIds.has(c.id)){
      ownedListEl.appendChild(makeCardElement(c, false));
    }
  });
}

// 카드 엘리먼트 만들기
function makeCardElement(card, inSlot){
  const el = document.createElement('div');
  el.className = 'card' + (inSlot ? ' small' : '');
  el.draggable = true;
  el.dataset.cardId = card.id;
  el.dataset.from   = inSlot ? 'slot' : 'pool';
  el.style.background = card.img ? '#fff' : (card.color || '#eee');

  if(card.img){
    const img = document.createElement('img');
    img.src = card.img; img.alt = card.name;
    el.appendChild(img);
  } else {
    el.textContent = card.name;
  }

  addCardDnD(el);
  return el;
}

/* =========================
   Drag & Drop
   ========================= */
function addCardDnD(cardEl){
  cardEl.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/plain', JSON.stringify({
      cardId: cardEl.dataset.cardId,
      from: cardEl.dataset.from,
      slotIndex: cardEl.closest('.slot') ? Number(cardEl.closest('.slot').dataset.index) : null
    }));
    // Firefox에서 드래그 이미지가 없으면 이벤트가 취소되는 문제 방지
    if(e.dataTransfer.setDragImage){ e.dataTransfer.setDragImage(cardEl, 10, 10); }
  });
}

// 슬롯 드롭 설정
function addSlotDnD(slotEl){
  slotEl.addEventListener('dragover', e=>{
    e.preventDefault(); slotEl.classList.add('over');
  });
  slotEl.addEventListener('dragleave', ()=> slotEl.classList.remove('over'));
  slotEl.addEventListener('drop', e=>{
    e.preventDefault(); slotEl.classList.remove('over');
    const data = JSON.parse(e.dataTransfer.getData('text/plain') || '{}');
    if(!data.cardId) return;

    const idx = Number(slotEl.dataset.index);
    const prev = DECK[idx];

    // 같은 카드가 다른 슬롯에 이미 있는지? (중복 허용/비허용 결정)
    const already = DECK.findIndex(id => id === data.cardId);
    if(already !== -1 && already !== idx){
      // 이미 다른 슬롯에 있음 → 그 슬롯 비우기 (이동)
      DECK[already] = null;
    }

    DECK[idx] = data.cardId;

    // 드래그 출발지가 슬롯이면 그 자리 비우기
    if(data.from === 'slot' && data.slotIndex != null && data.slotIndex !== idx){
      DECK[data.slotIndex] = prev || null;
    }

    renderSlots(); renderOwned(); saveDeck(DECK);
  });

  // 아래 카드 풀로 드롭하면 슬롯 카드 해제
  ownedListEl.addEventListener('dragover', e=>e.preventDefault());
  ownedListEl.addEventListener('drop', e=>{
    const data = JSON.parse(e.dataTransfer.getData('text/plain') || '{}');
    if(data.from === 'slot' && typeof data.slotIndex === 'number'){
      DECK[data.slotIndex] = null;
      renderSlots(); renderOwned(); saveDeck(DECK);
    }
  });
}

/* =========================
   초기화 & 버튼
   ========================= */
document.getElementById('clearDeck').addEventListener('click', ()=>{
  DECK = Array(8).fill(null);
  renderSlots(); renderOwned(); saveDeck(DECK);
});

document.getElementById('saveDeck').addEventListener('click', ()=>{
  saveDeck(DECK);
  alert('덱이 저장되었습니다.');
});

// 시작
buildSlots();
renderSlots();
renderOwned();
// 최초 예시 소유 카드 저장(최초 1회만)
if(!localStorage.getItem(STORAGE_OWN)) saveOwned(OWNED);
</script>
</body>
</html>
